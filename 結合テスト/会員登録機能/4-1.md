# 会員登録機能

## テスト対象API:

- `POST /api/customers/saveCustomer` (会員登録機能)

## テストデータ準備方針:

- 各項目が欠如している時と形式が不正な時のバリデーションを定義する
- 正常テストに用いるすべての項目が適切に入力されたケースを用意する
- パスワード長について境界ケースを用意する
- リクエストボディが空、DBエラー、不正なJSON発生用のデータを用意する
- CustomerRepositoryのモックを用意する

## テストシナリオ

### No. 4-1
- テストケース名: 正常系 - 会員登録する（名前・メールアドレス・パスワード・住所・電話番号を漏れなく適切な形式で入力）
- 前提条件:
  - DBが利用可能な状態であること
- 手順:
  1. HTTP POSTリクエストを `/api/customers/saveCustomer` エンドポイントに送信する。リクエストボディに会員登録情報を含める。
- 入力データ:
  - リクエストボディ(JSON):
    ```json
    {
      "customerRequest": {
        "customerName": "会員 一郎",
        "email": "ichiro@test.com",
        "password":"00000000",
        "shippingAddress": "東京都千代田区テスト1-1",
        "phoneNumber": "03-1234-5678"
      }
    }
    ```
- 期待結果:
  1. HTTPステータスコードが `201 Created` であること。
  2. レスポンスボディが空であること。
  3. DB状態変化:
     - `customer` テーブルに1件レコードが追加され、名前、メールアドレス、パスワード、住所、電話番号、ステータス("CREATED")などが正しく登録されていること。
     
  4. `CustomerService.savecustomer` が1回呼び出されること。
  5. `CustomerRepository.save` が1回呼び出されること。


### No. 4-2
- テストケース名: 異常系 - 会員登録時に名前が入力されていない
- 前提条件:
  - DBが利用可能な状態であること
  - バリデーションが定義されていること
  - 他の項目は入力されており、形式も正しいこと
- 手順:
  1. HTTP POSTリクエストを `/api/customers/saveCustomer` エンドポイントに送信する。リクエストボディの会員登録情報の名前を空にする。
- 入力データ:
  - リクエストボディ(JSON):
    ```json
    {
      "customerRequest": {
        "customerName": "", //空文字
        "email": "ichiro@test.com",
        "password":"00000000",
        "shippingAddress": "東京都千代田区テスト1-1",
        "phoneNumber": "03-1234-5678"
      }
    }
    ```
- 期待結果:
  1. HTTPステータスコードが `400 Bad Request` であること。
  2. レスポンスボディに `customerRequest.customerName` に関するバリデーションエラーメッセージ（"お名前は必須です"）を含むJSONが返却されること。
  3. `CustomerController` の `saveCustomer` メソッド内でバリデーションエラーが発生し、`CustomerService` は呼び出されないこと。
  4. DB状態変化: なし。


### No. 4-3
- テストケース名: 異常系 - 会員登録時にメールアドレスが入力されていない
- 前提条件:
  - DBが利用可能な状態であること
  - バリデーションが定義されていること
  - 他の項目は入力されており、形式も正しいこと
- 手順:
  1. HTTP POSTリクエストを `/api/customers/saveCustomer` エンドポイントに送信する。リクエストボディの会員登録情報のメールアドレスを空にする。
- 入力データ:
  - リクエストボディ(JSON):
    ```json
    {
      "customerRequest": {
        "customerName": "会員 一郎", 
        "email": "", //空文字
        "password":"00000000",
        "shippingAddress": "東京都千代田区テスト1-1",
        "phoneNumber": "03-1234-5678"
      }
    }
    ```
- 期待結果:
  1. HTTPステータスコードが `400 Bad Request` であること。
  2. レスポンスボディに `customerRequest.email` に関するバリデーションエラーメッセージ（"有効なメールアドレスを入力してください"）を含むJSONが返却されること。
  3. `CustomerController` の `saveCustomer` メソッド内でバリデーションエラーが発生し、`CustomerService` は呼び出されないこと。
  4. DB状態変化: なし。

### No. 4-4
- テストケース名: 異常系 - 会員登録時にパスワードが入力されていない
- 前提条件:
 - DBが利用可能な状態であること
  - バリデーションが定義されていること
  - 他の項目は入力されており、形式も正しいこと 
- 手順:
  1. HTTP POSTリクエストを `/api/customers/saveCustomer` エンドポイントに送信する。リクエストボディの会員登録情報のパスワードを空にする。
- 入力データ:
  - リクエストボディ(JSON):
    ```json
    {
      "customerRequest": {
        "customerName": "会員 一郎", 
        "email": "ichiro@test.com", 
        "password":"",　//空文字
        "shippingAddress": "東京都千代田区テスト1-1",
        "phoneNumber": "03-1234-5678"
      }
    }
    ```
- 期待結果:
  1. HTTPステータスコードが `400 Bad Request` であること。
  2. レスポンスボディに `customerRequest.password` に関するバリデーションエラーメッセージ（"パスワードは必須です"）を含むJSONが返却されること。
  3. `CustomerController` の `saveCustomer` メソッド内でバリデーションエラーが発生し、`CustomerService` は呼び出されないこと。
  4. DB状態変化: なし。

### No. 4-5
- テストケース名: 異常系 - 会員登録時に住所が入力されていない
- 前提条件:
 - DBが利用可能な状態であること
  - バリデーションが定義されていること
  - 他の項目は入力されており、形式も正しいこと
- 手順:
  1. HTTP POSTリクエストを `/api/customers/saveCustomer` エンドポイントに送信する。リクエストボディの会員登録情報の住所を空にする。
- 入力データ:
  - リクエストボディ(JSON):
    ```json
    {
      "customerRequest": {
        "customerName": "会員 一郎", 
        "email": "ichiro@test.com", 
        "password":"00000000",　
        "shippingAddress": "", //空文字
        "phoneNumber": "03-1234-5678"
      }
    }
    ```
- 期待結果:
  1. HTTPステータスコードが `400 Bad Request` であること。
  2. レスポンスボディに `customerRequest.shippingAddress` に関するバリデーションエラーメッセージ（"住所は必須です"）を含むJSONが返却されること。
  3. `CustomerController` の `saveCustomer` メソッド内でバリデーションエラーが発生し、`CustomerService` は呼び出されないこと。
  4. DB状態変化: なし。

### No. 4-6
- テストケース名: 異常系 - 会員登録時に電話番号が入力されていない
- 前提条件:
  - DBが利用可能な状態であること
  - バリデーションが定義されていること
  - 他の項目は入力されており、形式も正しいこと
- 手順:
  1. HTTP POSTリクエストを `/api/customers/saveCustomer` エンドポイントに送信する。リクエストボディの会員登録情報の電話番号を空にする。
- 入力データ:
  - リクエストボディ(JSON):
    ```json
    {
      "customerRequest": {
        "customerName": "会員 一郎", 
        "email": "ichiro@test.com", 
        "password":"00000000",　
        "shippingAddress": "東京都千代田区テスト1-1", 
        "phoneNumber": "" //空文字
      }
    }
    ```
- 期待結果:
  1. HTTPステータスコードが `400 Bad Request` であること。
  2. レスポンスボディに `customerRequest.phoneNumber` に関するバリデーションエラーメッセージ（"住所は必須です"）を含むJSONが返却されること。
  3. `CustomerController` の `saveCustomer` メソッド内でバリデーションエラーが発生し、`CustomerService` は呼び出されないこと。
  4. DB状態変化: なし。

### No. 4-7
- テストケース名: 異常系 - 会員登録時のメールアドレスの形式が不正
- 前提条件:
  - DBが利用可能な状態であること
  - バリデーションが定義されていること
  - 他の項目は入力されており、形式も正しいこと
- 手順:
  1. HTTP POSTリクエストを `/api/customers/saveCustomer` エンドポイントに送信する。リクエストボディの会員登録情報のメールアドレスを不正な形式にする。
- 入力データ:
  - リクエストボディ(JSON):
    ```json
    {
      "customerRequest": {
        "customerName": "会員 一郎", 
        "email": "test", //不正な形式
        "password":"00000000",　
        "shippingAddress": "東京都千代田区テスト1-1", 
        "phoneNumber": "03-1234-5678" 
      }
    }
    ```
- 期待結果:
  1. HTTPステータスコードが `400 Bad Request` であること。
  2. レスポンスボディに `customerRequest.email` に関するバリデーションエラーメッセージ（"有効なメールアドレスを入力してください"）を含むJSONが返却されること。
  3. `CustomerController` の `saveCustomer` メソッド内でバリデーションエラーが発生し、`CustomerService` は呼び出されないこと。
  4. DB状態変化: なし。

### No. 4-8
- テストケース名: 異常系 - 会員登録時のパスワードの文字数が1文字以上7文字以下
- 前提条件:
  - DBが利用可能な状態であること
  - バリデーションが定義されていること
  - 他の項目は入力されており、形式も正しいこと
- 手順:
  1. HTTP POSTリクエストを `/api/customers/saveCustomer` エンドポイントに送信する。リクエストボディの会員登録情報のパスワードを1文字以上7文字以下にする。
- 入力データ:
  - リクエストボディ(JSON):
    ```json
    {
      "customerRequest": {
        "customerName": "会員 一郎", 
        "email": "ichiro@test.com", 
        "password":"0000000",　//文字数不足
        "shippingAddress": "東京都千代田区テスト1-1",
        "phoneNumber": "03-1234-5678"
      }
    }
    ```
- 期待結果:
  1. HTTPステータスコードが `400 Bad Request` であること。
  2. レスポンスボディに `customerRequest.password` に関するバリデーションエラーメッセージ（"パスワードは8文字以上で設定してください"）を含むJSONが返却されること。
  3. `CustomerController` の `saveCustomer` メソッド内でバリデーションエラーが発生し、`CustomerService` は呼び出されないこと。
  4. DB状態変化: なし。

### No. 4-9
- テストケース名: 異常系 - 会員登録時のリクエストボディが空、または不正なJSON
- 前提条件:
  - コントローラーが@RequestBodyを使用していること
- 手順:
  1. HTTP POSTリクエストを `/api/customers/saveCustomer` エンドポイントに送信する。リクエストボディを空にするか、JSONとして不正な形式にする。
- 入力データ:
  - リクエストボディ: 空
- 期待結果:
  1. HTTPステータスコードが `400 Bad Request` または `500 Internal Server Error` であること (Spring MVCのメッセージコンバーターやバリデーションでのエラー)。
  2. `CustomerController.saveCustomer` が呼び出される前にエラーを発生する可能性が高い。
  3. DB状態変化: なし。

### No. 4-10
- テストケース名: 異常系 - （DB停止）会員DB保存時にエラー発生
- 前提条件:
  - (テスト実装上の工夫): `CustomerRepository.save` メソッドが呼び出された際に、意図的に例外（例: `RuntimeException("DB save error")`）をスローするようにモックまたはテスト用実装で設定する。
- 手順:
  1. HTTP POSTリクエストを `/api/customers/saveCustomer` エンドポイントに送信する。
- 入力データ:
  - リクエストボディ(JSON): (No. 4-1 と同様の会員登録情報)
  - セッション: 上記前提条件のカート情報
- 期待結果:
  1. HTTPステータスコードが `500 Internal Server Error` であること。
  2. レスポンスボディにエラーメッセージ（例: "DB save error" を含むJSON）が返却されること。
  3. DB状態変化: `customer`, テーブルに変化がないこと（`@Transactional` によりロールバックされる）。
  4. `CustomerService.saveCustomer` 内で `customerRepository.save` が呼び出され、そこで例外が発生すること。
  